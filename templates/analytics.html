{% extends 'base.html' %}
{% load static %}
{% block content %}
<div class="container py-5">
  <h2 class="fw-bold mb-4">Inventory Analytics</h2>

  <!-- In Stock Products Chart -->
  <div class="card mb-5">
    <div class="card-header bg-success text-white">Products In Stock</div>
    <div class="card-body">
    <canvas id="inStockChart" width="400" height="200"></canvas>
    </div>
  </div>

  <!-- Real-Time Product Consumption Chart -->
  <div class="card mb-5">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
      <span>Real-Time Product Consumption</span>
      <select id="periodSelect" class="form-select form-select-sm w-auto">
        <option value="daily">Daily (Last 7 days)</option>
        <option value="weekly">Weekly (Last 8 weeks)</option>
        <option value="monthly">Monthly (Last 12 months)</option>
      </select>
    </div>
    <div class="card-body">
      <canvas id="realTimeConsumptionChart" width="400" height="200"></canvas>
      <div class="text-center mt-3">
        <small class="text-muted" id="chartInfo">Updates automatically when products are consumed</small>
      </div>
    </div>
  </div>

  <!-- Historical Most Consumed Products Chart -->
  <div class="card mb-5">
    <div class="card-header bg-secondary text-white">Historical Most Consumed Products</div>
    <div class="card-body">
      <form method="get" class="mb-3">
        <select name="period" class="form-select w-auto d-inline-block">
          <option value="daily" {% if period == 'daily' %}selected{% endif %}>Daily</option>
          <option value="weekly" {% if period == 'weekly' %}selected{% endif %}>Weekly</option>
          <option value="monthly" {% if period == 'monthly' %}selected{% endif %}>Monthly</option>
        </select>
        <button type="submit" class="btn btn-primary">Show</button>
      </form>
      <canvas id="mostConsumedChart"></canvas>
    </div>
  </div>
</div>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // In Stock Chart Data
  const inStockLabels = [{% for product in in_stock_products %}'{{ product.name }}'{% if not forloop.last %},{% endif %}{% endfor %}];
  const inStockData = [{% for product in in_stock_products %} {{ product.currentStock }}{% if not forloop.last %},{% endif %}{% endfor %}];

  new Chart(document.getElementById('inStockChart'), {
    type: 'bar',
    data: {
      labels: inStockLabels,
      datasets: [{
        label: 'Current Stock',
        data: inStockData,
        backgroundColor: 'rgba(40,167,69,0.6)'
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false } }
    }
  });

  // Most Consumed Chart Data
  const consumedLabels = [{% for item in most_consumed %}'{{ item.product__name }}'{% if not forloop.last %},{% endif %}{% endfor %}];
  const consumedData = [{% for item in most_consumed %}{{ item.total_quantity }}{% if not forloop.last %},{% endif %}{% endfor %}];

  new Chart(document.getElementById('mostConsumedChart'), {
    type: 'bar',
    data: {
      labels: consumedLabels,
      datasets: [{
        label: 'Quantity Consumed',
        data: consumedData,
        backgroundColor: 'rgba(0,123,255,0.6)'
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false } }
    }
  });

  // Real-Time Consumption Chart
  let realTimeChart;
  
  function initRealTimeChart() {
    const ctx = document.getElementById('realTimeConsumptionChart').getContext('2d');
    realTimeChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: [],
        datasets: [{
          label: 'Quantity Consumed',
          data: [],
          backgroundColor: 'rgba(54, 162, 235, 0.6)',
          borderColor: 'rgba(54, 162, 235, 1)',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        plugins: { 
          legend: { display: true },
          title: {
            display: true,
            text: 'Real-Time Product Consumption'
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Quantity Consumed'
            }
          },
          x: {
            title: {
              display: true,
              text: 'Products'
            }
          }
        }
      }
    });
  }

  // Update Real-Time Consumption Chart
  function updateRealTimeChart() {
    const period = document.getElementById('periodSelect').value;
    const chartInfo = document.getElementById('chartInfo');
    
    chartInfo.textContent = 'Loading consumption data...';
    
    fetch(`/api/real-time-analytics/?period=${period}`)
      .then(response => response.json())
      .then(data => {
        console.log('Analytics data received:', data); // Debug log
        
        realTimeChart.data.labels = data.labels;
        realTimeChart.data.datasets[0].data = data.data;
        realTimeChart.update();
        
        const periodText = {
          'daily': 'Last 7 days',
          'weekly': 'Last 8 weeks', 
          'monthly': 'Last 12 months'
        };
        
        if (data.labels.length > 0) {
          chartInfo.textContent = `${periodText[data.period]} - Showing ${data.labels.length} most consumed products`;
        } else {
          chartInfo.textContent = `${periodText[data.period]} - No consumption data available for this period`;
        }
      })
      .catch(error => {
        console.error('Error fetching analytics data:', error);
        chartInfo.textContent = 'Error loading consumption data';
      });
  }

  // Initialize chart and set up event listeners
  document.addEventListener('DOMContentLoaded', function() {
    initRealTimeChart();
    updateRealTimeChart(); // Load initial data
    
    // Update chart when period changes
    document.getElementById('periodSelect').addEventListener('change', updateRealTimeChart);
    
    // Auto-refresh every 30 seconds
    setInterval(updateRealTimeChart, 30000);
  });

  // Function to trigger chart update from other pages (when stock is consumed)
  window.updateConsumptionChart = function() {
    if (typeof updateRealTimeChart === 'function') {
      updateRealTimeChart();
    }
  };
</script>
{% endblock %}